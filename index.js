const express = require('express')
const bodyParser = require('body-parser')
const moment = require('moment')
const cookieSession = require('cookie-session')
require('dotenv').load()
const app = express()

const routes = require('./routes')
const { setTasks } = require('./services/tasks')

app.set('view engine', 'pug')
app.locals.moment = moment

app.use(express.static('public'))

app.use(cookieSession({
  name: 'jm-cookie-session',
  keys: ['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']
}))

app.use((req, res, next) => {
  req.session.tasks = req.session.tasks || []
  setTasks(req.session.tasks)
  next()
})

app.use(bodyParser.urlencoded({ extended: false }))
app.use(bodyParser.json())

app.use(routes)

app.listen(3000)
console.log('Listening on PORT 3000...')
